name: Build APK Calculadora

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    
    - name: DEBUG - Listar archivos
      run: |
        echo "üìÅ Contenido del directorio:"
        ls -la
        echo "-------------------"
        echo "üîç Buscando archivos Python:"
        find . -name "*.py" -type f
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git wget unzip \
          python3-pip python3-dev build-essential \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev libgstreamer1.0-0 gstreamer1.0-plugins-base \
          libffi-dev autoconf automake libtool pkg-config openjdk-17-jdk
        
        pip install --upgrade pip
        pip install buildozer cython kivy
    
    - name: Prepare main.py
      run: |
        # TU ARCHIVO ESPEC√çFICO: calc_kivy_precalculo_beta.py
        if [ -f "calc_kivy_precalculo_beta.py" ]; then
          echo "‚úÖ Encontrado: calc_kivy_precalculo_beta.py"
          cp calc_kivy_precalculo_beta.py main.py
          echo "‚úÖ Copiado a main.py"
        else
          echo "‚ùå No se encuentra calc_kivy_precalculo_beta.py"
          echo "Archivos disponibles:"
          ls -la *.py 2>/dev/null || echo "No hay archivos .py"
          exit 1
        fi
        
        echo "üìÅ Verificaci√≥n:"
        ls -la main.py
    
    - name: Initialize Buildozer
      run: |
        buildozer init
        
        # Configurar buildozer.spec
        sed -i 's/title = My Application/title = Calculadora Matematica/g' buildozer.spec
        sed -i 's/package.name = myapp/package.name = calculadoramath/g' buildozer.spec
        sed -i 's/package.domain = org.test/package.domain = com.math.app/g' buildozer.spec
        sed -i 's/requirements = python3,kivy/requirements = python3,kivy/g' buildozer.spec
        sed -i 's/# android.accept_sdk_license = False/android.accept_sdk_license = True/g' buildozer.spec
        sed -i 's/# android.ndk = 23b/android.ndk = 25b/g' buildozer.spec
        sed -i 's/# android.sdk = 24/android.sdk = 30/g' buildozer.spec
        
        echo "‚úÖ buildozer.spec configurado"
    
    - name: Build APK
      run: |
        echo "üöÄ Compilando (20-30 minutos)..."
        buildozer -v android debug
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Calculadora-APK
        path: ./bin/*.apk
      if: success()
