name: Build APK Calculadora

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    
    - name: DEBUG - Listar archivos
      run: |
        echo "ðŸ“ Contenido del directorio:"
        ls -la
        echo "-------------------"
        echo "ðŸ” Buscando archivos Python:"
        find . -name "*.py" -type f
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git wget unzip \
          python3-pip python3-dev build-essential \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev libgstreamer1.0-0 gstreamer1.0-plugins-base \
          libffi-dev autoconf automake libtool pkg-config openjdk-17-jdk
        
        pip install --upgrade pip
        pip install buildozer cython kivy
    
    - name: Prepare main.py
      run: |
        # TU ARCHIVO ESPECÃFICO: calc_kivy_precalculo_beta.py
        if [ -f "calc_kivy_precalculo_beta.py" ]; then
          echo "âœ… Encontrado: calc_kivy_precalculo_beta.py"
          cp calc_kivy_precalculo_beta.py main.py
          echo "âœ… Copiado a main.py"
        else
          echo "âŒ No se encuentra calc_kivy_precalculo_beta.py"
          echo "Archivos disponibles:"
          ls -la *.py 2>/dev/null || echo "No hay archivos .py"
          exit 1
        fi
        
        echo "ðŸ“ VerificaciÃ³n:"
        ls -la main.py
    
    # ðŸ”¥ NUEVO: Crear parche para solucionar el error de pyjnius ðŸ”¥
    - name: Crear parche para pyjnius (fix long type)
      run: |
        echo "ðŸ“ Creando estructura de carpetas para receta local..."
        mkdir -p .p4a-recipes/pyjnius/patches
        
        echo "ðŸ“ Creando archivo de parche..."
        cat > .p4a-recipes/pyjnius/patches/fix-long.patch << 'EOF'
--- a/jnius/jnius_utils.pxi
+++ b/jnius/jnius_utils.pxi
@@ -319,8 +319,7 @@
                 score += 10
                 continue
 
-        if r == 'S' or r == 'I':
-            if isinstance(arg, int) or (
-                    (isinstance(arg, long) and arg < 2147483648)):
+        if (r == 'S' or r == 'I') and isinstance(arg, int):
                 score += 10
                 continue
EOF
        echo "âœ… Parche para pyjnius creado correctamente"
        echo "ðŸ“ Contenido de .p4a-recipes:"
        ls -la .p4a-recipes/pyjnius/patches/
    
    - name: Initialize Buildozer
      run: |
        buildozer init
        
        # ðŸ”¥ NUEVO: Configurar ruta de recetas locales ðŸ”¥
        echo "âš™ï¸ Configurando ruta de recetas locales en buildozer.spec..."
        sed -i 's/^#p4a\.local_recipes = .*/p4a.local_recipes = .\/.p4a-recipes/' buildozer.spec
        
        # Configurar buildozer.spec (tus configuraciones existentes)
        sed -i 's/title = My Application/title = Calculadora Matematica/g' buildozer.spec
        sed -i 's/package.name = myapp/package.name = calculadoramath/g' buildozer.spec
        sed -i 's/package.domain = org.test/package.domain = com.math.app/g' buildozer.spec
        sed -i 's/requirements = python3,kivy/requirements = python3,kivy/g' buildozer.spec
        sed -i 's/# android.accept_sdk_license = False/android.accept_sdk_license = True/g' buildozer.spec
        sed -i 's/# android.ndk = 23b/android.ndk = 25b/g' buildozer.spec
        sed -i 's/# android.sdk = 24/android.sdk = 30/g' buildozer.spec
        
        echo "âœ… Verificando configuraciÃ³n final:"
        grep -E "title|package|requirements|android.accept|android.ndk|android.sdk|p4a.local_recipes" buildozer.spec
        echo "âœ… buildozer.spec configurado"
    
    - name: Build APK
      run: |
        echo "ðŸš€ Compilando (20-30 minutos)..."
        buildozer -v android debug
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Calculadora-APK
        path: ./bin/*.apk
      if: success()
